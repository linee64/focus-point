import { GoogleGenerativeAI } from "@google/generative-ai";

const API_KEY = "AIzaSyB97beBGQ7LNl2R-j0m3WTPgd5663Wmzw4"; // –í –±—É–¥—É—â–µ–º –Ω—É–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ .env
const genAI = new GoogleGenerativeAI(API_KEY);

export const analyzeVideo = async (videoSource: string | File, isUrl: boolean = true) => {
  try {
    const model = genAI.getGenerativeModel({ 
      model: "gemini-1.5-pro",
      generationConfig: {
        temperature: 0.7,
        topP: 0.8,
        topK: 40,
        maxOutputTokens: 2048,
      }
    });

    let prompt = `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-—Ç—å—é—Ç–æ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º—É –≤–∏–¥–µ–æ.

    –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ, –ø–æ–ø—Ä–æ–±—É–π –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ URL) –∏–ª–∏ –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ù–æ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –≤—ã–¥–∞—Ç—å –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã.

    –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ (Markdown):
    # üìå [–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã]

    ## üéØ –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
    –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á–µ–º—É —É—á–∏—Ç —ç—Ç–æ –≤–∏–¥–µ–æ.

    ## üìù –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã
    - –í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 1
    - –í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 2

    ## üí° –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
    **–¢–µ—Ä–º–∏–Ω** ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.

    ## üõ† –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
    –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

    ## üèÅ –†–µ–∑—é–º–µ
    –ò—Ç–æ–≥–æ–≤–∞—è –º—ã—Å–ª—å –≤ –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏.

    –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.`;

    if (isUrl) {
      const result = await model.generateContent([
        prompt,
        { text: `–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ: ${videoSource}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –≤–∏–¥–µ–æ –∏ —Å–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Å–ø–µ–∫—Ç.` }
      ]);
      const response = await result.response;
      const text = response.text();
      
      if (!text || text.trim().length < 10) {
        throw new Error("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò.");
      }
      
      return text;
    } else {
      // –ò–º–∏—Ç–∞—Ü–∏—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
      await new Promise(resolve => setTimeout(resolve, 2000));
      return `# üìÅ –ö–æ–Ω—Å–ø–µ–∫—Ç —Ñ–∞–π–ª–∞: ${(videoSource as File).name}

## üéØ –ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä—è–¥ –∏ –∞—É–¥–∏–æ–¥–æ—Ä–æ–∂–∫—É –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞.

## üìù –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- –í –≤–∏–¥–µ–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã.
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
- –î–∞–Ω—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.

## üí° –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
**–ò–Ω—Å–∞–π—Ç** ‚Äî —Ü–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –≤ —Ö–æ–¥–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.

## üèÅ –í—ã–≤–æ–¥
–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—ã–π –æ–±—É—á–∞—é—â–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª.

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.*`;
    }
  } catch (error: any) {
    console.error("Gemini Analysis Error:", error);
    if (error.message?.includes("API key")) {
      throw new Error("–û—à–∏–±–∫–∞ API –∫–ª—é—á–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞.");
    }
    throw new Error(error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
};
